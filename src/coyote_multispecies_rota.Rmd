---
title: "coyote_multispecies_rota"
output: html_document
---

```{r}
library(vroom)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(lubridate)
library(MASS)
library(hms)
library(unmarked)
library(camtrapR)
library(overlap)
library(stars)
library(sf)
library(terra)
library(rstan)
library(cmdstanr)
library(rjags)
library(Rcpp)
library(stringr)
```

#Formatting detection non-detection data

```{r}
coyote <- as.matrix(read.csv("data/coyotedetections_boreal.csv"))
lynx <- as.matrix(read.csv("data/lynxdetections_boreal.csv"))
marten <- as.matrix(read.csv("data/martendetections_boreal.csv"))
fisher <- as.matrix(read.csv("data/fisherdetections_boreal.csv"))
```

#Load in covariate data

```{r}
climate <- read.csv("data/climatecovars.csv")
hf <- read.csv("data/hfcovars.csv")
```

##Covariate data
```{r}
covars <- bind_cols(climate, hf[,4])

covars<-rename(covars, hf = ...6)
```

##Single Species
```{r}
umf_coyote <- unmarkedFrameOccu(
  y = coyote,
  siteCovs = covars
)

mod_coyote <- occu(
  formula = ~1 ~PC1*hf + PC2*hf, 
  data = umf_coyote
)

summary(mod_coyote)
```

##Occumulti approach - coyote lynx only
```{r}
ylist_lynx <- list(coyote = coyote, lynx = lynx)

ylist_lynx$coyote[is.na(ylist_lynx$coyote)] <- 0
ylist_lynx$lynx[is.na(ylist_lynx$lynx)] <- 0

umf_lynx <- unmarkedFrameOccuMulti(y = ylist_lynx, siteCovs = covars)

stateformulas_lynx <- c("~PC1*hf + PC2*hf", "~PC1*hf + PC2*hf", "~PC1*hf + PC2*hf")
detformulas_lynx <-  c("~1", "~1")

mod_lynx <- occuMulti(
  detformulas = detformulas_lynx,
  stateformulas = stateformulas_lynx,
  data = umf_lynx,
  method = "BFGS",
  se =TRUE
)

summary(mod_lynx)
coef(mod_lynx)
SE(mod_lynx)             # standard errors
confint(mod_lynx, type = "state")        # confidence intervals
```

##Marginal occupancy coyote-lynx
```{r}

```

##Conditional occupancy coyote-lynx Climate pc1
```{r}
pc1data <- data.frame(
  PC1 = seq(min(covars$PC1, na.rm = TRUE),
           max(covars$PC1, na.rm = TRUE),
           length.out = 100),
  PC2 = mean(covars$PC2, na.rm = TRUE),  # fix other covariates
  hf = mean(covars$hf, na.rm = TRUE)
)


# Example: conditional occupancy of coyote given lynx present
pred_cond <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc1data    # a data.frame with covariates of interest
)

# Coyote occupancy given lynx present
pred_lynx_present <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc1data
)

# Coyote occupancy given lynx absent
pred_lynx_absent <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = pc1data
)

df <- data.frame(
  cov = pc1data$PC1,
  present = pred_lynx_present$Predicted,
  lower_present = pred_lynx_present$lower,
  upper_present = pred_lynx_present$upper,
  absent = pred_lynx_absent$Predicted,
  lower_absent = pred_lynx_absent$lower,
  upper_absent = pred_lynx_absent$upper
)


ggplot(df, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Human footprint",
       title = "Lynx occupancy conditional on coyote presence (blue) vs absence (red)")


```

##Conditional occupancy coyote-lynx Climate pc2
```{r}
pc2data <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 100),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = mean(covars$hf, na.rm = TRUE)
)


# Example: conditional occupancy of coyote given lynx present
pred_cond_pc2 <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc2data    # a data.frame with covariates of interest
)

# Coyote occupancy given lynx present
pred_lynx_present_pc2 <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc2data
)

# Coyote occupancy given lynx absent
pred_lynx_absent_pc2 <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = pc2data
)

df_pc2 <- data.frame(
  cov = pc2data$PC2,
  present = pred_lynx_present_pc2$Predicted,
  lower_present = pred_lynx_present_pc2$lower,
  upper_present = pred_lynx_present_pc2$upper,
  absent = pred_lynx_absent_pc2$Predicted,
  lower_absent = pred_lynx_absent_pc2$lower,
  upper_absent = pred_lynx_absent_pc2$upper
)


ggplot(df_pc2, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Climate pc2",
       title = "Lynx occupancy conditional on coyote presence (blue) vs absence (red)")


```

##Conditional occupancy coyote-lynx Climate hf
```{r}
hfdata <- data.frame(
  hf = seq(min(covars$hf, na.rm = TRUE),
           max(covars$hf, na.rm = TRUE),
           length.out = 100),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  PC2 = mean(covars$PC2, na.rm = TRUE)
)


# Example: conditional occupancy of coyote given lynx present
pred_cond_hf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = hfdata    # a data.frame with covariates of interest
)

# Coyote occupancy given lynx present
pred_lynx_present_hf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = hfdata
)

# Coyote occupancy given lynx absent
pred_lynx_absent_hf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = hfdata
)

df_hf <- data.frame(
  cov = hfdata$hf,
  present = pred_lynx_present_hf$Predicted,
  lower_present = pred_lynx_present_hf$lower,
  upper_present = pred_lynx_present_hf$upper,
  absent = pred_lynx_absent_hf$Predicted,
  lower_absent = pred_lynx_absent_hf$lower,
  upper_absent = pred_lynx_absent_hf$upper
)


ggplot(df_hf, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Human footprint",
       title = "Lynx occupancy conditional on coyote presence (blue) vs absence (red)")


```

```{r}
newdata_coylynx <- data.frame(
  PC1 = seq(min(covars$PC1), max(covars$PC1), length.out=50),
  PC2 = mean(covars$PC2),
  hf = mean(covars$hf)
)

pred_lynxcoy <- predict(mod_lynx, type = "state")

psi_coy <- pred_lynxcoy$Predicted[,2] + pred_lynxcoy$Predicted[,1]
psi_lynx <- pred_lynxcoy$Predicted[,3] + pred_lynxcoy$Predicted[,1]

psi_lynx_given_coy <- pred_lynxcoy$Predicted[,1] / (pred_lynxcoy$Predicted[,3] + pred_lynxcoy$Predicted[,1])
psi_lynx_given_no_coy <- pred_lynxcoy$Predicted[,3] / (pred_lynxcoy$Predicted[,4] + pred_lynxcoy$Predicted[,2])

pred <- data.frame(
  psi_coy = psi_coy,
  psi_lynx = psi_lynx,
  psi_lynx_given_coy,
  psi_lynx_given_no_coy
)

df_plot <-
```


```{r}
hf_range <- range(siteCovs(umf_lynx)$hf)
hf_seq <- seq(hf_range[1], hf_range[2], length.out = 100)

PC1_mean <- mean(covars$PC1)
PC2_mean <- mean(covars$PC2)

nd <- data.frame(PC1 = PC1_mean,
                 PC2 = PC2_mean,
                 hf = hf_seq
                 )

occ_hf_coy <- predict(mod_lynx, type="state", species="coyote", newdata=nd)
occ_hf_coy$Species <- "Coyote"
occ_hf_coy$hf <- hf_seq

head(occ_hf_coy)

occ_hf_lynx <- predict(mod_lynx, type="state", species="lynx", newdata=nd)
occ_hf_lynx$Species <- "Lynx"
occ_hf_lynx$hf <- hf_seq

plot(occ_hf_coy$hf, occ_hf_coy$Predicted, type='l', ylim=c(0,1),
     col='red', lwd=2, xlab="human footprint", ylab="Marginal occupancy")
lines(occ_hf_lynx$hf, occ_hf_lynx$Predicted, col='blue', lwd=2)


```

##Occumulti approach - all species
```{r}
ylist <- list(coyote = coyote, lynx = lynx, marten = marten,  fisher = fisher)

ylist$coyote[is.na(ylist$coyote)] <- 0
ylist$lynx[is.na(ylist$lynx)] <- 0
ylist$marten[is.na(ylist$marten)] <- 0
ylist$fisher[is.na(ylist$fisher)] <- 0

lapply(ylist, head)
```


```{r}
umf <- unmarkedFrameOccuMulti(y = ylist, siteCovs = covars)
```

```{r}
umf@fDesign

colnames(umf@fDesign)

stateformulas <- c("~1", "~1", "~1", "~1", "~1", "~1", "~1", "0", "0", "0", "0", "0", "0", "0", "0")

detformulas <- c("~1","~1","~1", "~1")

start_vals <- rep(0.5, 8)

y_mat <- do.call(cbind, lapply(ylist, rowSums))
cor(y_mat > 0)

```

```{r}
mod_null <- occuMulti(detformulas = detformulas, stateformulas = stateformulas, data = umf, method = "BFGS", se = TRUE)
summary(mod_null)
```
```{r}
umf@fDesign

colnames(umf@fDesign)

clim1_phi <- c("~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "0", "0", "0", "0", "0", "0", "0", "0")

clim1_p <- c("~1","~1","~1", "~1")

start_vals <- rep(0.5, 8)

y_mat <- do.call(cbind, lapply(ylist, rowSums))
cor(y_mat > 0)

```

```{r}
mod_clim1 <- occuMulti(detformulas = clim1_p, stateformulas = clim1_phi, data = umf, method = "BFGS", se = TRUE)
summary(mod_clim1)
```

```{r}
occ_prob <- predict(mod_null, type="state")
```
##Bayesian Model
```{stan}
data {
  int<lower=1> N;           // number of sites
  int<lower=1> T;           // number of occasions
  int<lower=0,upper=1> y1[N, T];  // detections for species 1 (Coyote)
  int<lower=0,upper=1> y2[N, T];  // detections for species 2 (Lynx)
}

parameters {
  real<lower=0, upper=1> psi1;  // occupancy probability for Coyote
  real<lower=0, upper=1> psi2;  // occupancy probability for Lynx
  real<lower=0, upper=1> p1;    // detection probability for Coyote
  real<lower=0, upper=1> p2;    // detection probability for Lynx
}

transformed parameters {
  // none needed for basic model
}

model {
  // priors
  psi1 ~ beta(1,1);
  psi2 ~ beta(1,1);
  p1   ~ beta(1,1);
  p2   ~ beta(1,1);

  // likelihood
  for (i in 1:N) {
    // Coyote
    target += bernoulli_lpmf(max(y1[i,]) | psi1);  // occupancy contribution
    for (t in 1:T) {
      target += bernoulli_lpmf(y1[i,t] | p1 * psi1);
    }
    // Lynx
    target += bernoulli_lpmf(max(y2[i,]) | psi2);
    for (t in 1:T) {
      target += bernoulli_lpmf(y2[i,t] | p2 * psi2);
    }
  }
}

```

```{r}
# Replace NAs with 0 for y matrices (Stan cannot store NA) 
y1_clean <- coyote
y2_clean <- lynx
is_obs1 <- ifelse(is.na(y1_clean), 0, 1)
is_obs2 <- ifelse(is.na(y2_clean), 0, 1)
y1_clean[is.na(y1_clean)] <- 0
y2_clean[is.na(y2_clean)] <- 0

stan_data <- list(
  N = nrow(y1_clean),
  T = ncol(y1_clean),
  y1 = y1_clean,
  y2 = y2_clean,
  is_obs1 = is_obs1,
  is_obs2 = is_obs2
)

```

```{r}
library(rstan)

fit <- stan(
  file = "two_species_latent.stan",
  data = stan_data,
  chains = 4,
  iter = 2000
)

print(fit, pars=c("psi1","psi2","p1","p2"))


```

```{r}
for(sp in names(ylist_null)){
  cat("\nSpecies:", sp, "\n")
  mat <- ylist[[sp]]
  cat("Total detections:", sum(mat, na.rm=TRUE), "\n")
  cat("Number of sites with all zeros:", sum(rowSums(mat, na.rm=TRUE) == 0), "\n")
  cat("Number of sites with all ones:", sum(rowSums(mat, na.rm=TRUE) == ncol(mat)), "\n")
}

y1 <- matrix(c(1,0,0,1,0,1,0,0), nrow=4)
y2 <- matrix(c(0,1,0,1,0,0,1,0), nrow=4)
umf_test <- unmarkedFrameOccuMulti(y = list(Coyote=y1, Lynx=y2))
fit <- occuMulti(detformulas=c("~1","~1"), stateformulas=c("~1","~1","~1"), data=umf_test)
```

```{r}

# CREATING DESIGN MATRIX
X.array <- array(0, dim = c(nrow(coyote), 16, 32))

clim <- scale(psi.cov$MCMT)[, 1]
hf <- scale(psi.cov$RoadHardSurface_buf)[, 1]
lati <- scale(psi.cov$Latitude)[, 1]
long <- scale(psi.cov$Longitude)[, 1]
lbyl <- lati * long
hike <- scale(psi.cov$People_site * 1000 / cday)

# importing the general form of the design matrix
library(xlsx)
dm <- read.xlsx('Design Matrix.xlsx', 3, rowIndex = 3:18, colIndex = 2:33,
                header = F)

# filling in the design matrix
for(i in 1:nrow(coyote)){
  for(j in 1:15){
    X.array[i, j, dm[j, ] == 1] <-
      c(1, lati[i], long[i], lbyl[i], hike[i],
        1, lati[i], long[i], lbyl[i], hden[i],
        1, lati[i], long[i], lbyl[i], hden[i],
        1, lati[i], long[i], lbyl[i], hike[i],
        1, d5km[i],
        1, hden[i],
        1, hden[i],
        1, d5km[i],
        1, hden[i],
        1, d5km[i])[dm[j, ] == 1]
  }
}


# OBSERVED Y
y1max <- apply(coyote, 1, max, na.rm = T)
y2max <- apply(lynx, 1, max, na.rm = T)
y3max <- apply(marten, 1, max, na.rm = T)
y4max <- apply(fisher, 1, max, na.rm = T)

# Vectorizing detection / non-detection
Y1 <- Y2 <- Y3 <- Y4 <- trail <- dd <- numeric()
for(i in 1:nrow(bobcat)){
  Y1 <- c(Y1, bobcat[i, 1:cday[i]])
  Y2 <- c(Y2, coyote[i, 1:cday[i]])
  Y3 <- c(Y3, gryfox[i, 1:cday[i]])
  Y4 <- c(Y4, redfox[i, 1:cday[i]])
  trail <- c(trail, rep(psi.cov$Trail[i], cday[i]))
  dd <- c(dd, rep(p.cov$Det_dist[i], cday[i]))
}

# Stan does not support ragged indexing.  This is a work-around
start <- 1
for(i in 2:nrow(bobcat)){
  start <- c(start, sum(cday[1:(i - 1)]) + 1)
}

data <- list(
  K = ncol(X.array[1, , ]),
  L = 3,
  N = nrow(bobcat),
  NJ = length(Y1),
  S = 16,
  obs = cday,
  start = start,
  x = X.array,
  trl = trail,
  dd = scale(dd)[, 1],
  I1 = y1max, I2 = y2max, I3 = y3max, I4 = y4max,
  Y1 = Y1, Y2 = Y2, Y3 = Y3, Y4 = Y4
  )

inits <- function(){
  list(
    a1 = rnorm(3),
    a2 = rnorm(3),
    a3 = rnorm(3),
    a4 = rnorm(3),
    beta = rnorm(ncol(X.array[1, , ])))
}

params <- c('a1', 'a2', 'a3', 'a4', 'beta', 'll')

```


```{r}
```
