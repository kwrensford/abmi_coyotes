---
title: "coyote_multispecies_rota"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
library(vroom)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(lubridate)
library(MASS)
library(hms)
library(unmarked)
library(camtrapR)
library(overlap)
library(stars)
library(sf)
library(terra)
library(rstan)
library(cmdstanr)
library(rjags)
library(Rcpp)
library(stringr)
library(mgcv)
library(cowplot)
library(gridExtra)
```

#Formatting detection non-detection data

```{r}

coyote <- as.matrix(read.csv("data/coyotedetections.csv"))
lynx <- as.matrix(read.csv("data/lynxdetections.csv"))
marten <- as.matrix(read.csv("data/martendetections.csv"))
fisher <- as.matrix(read.csv("data/fisherdetections.csv"))

coyote[is.na(coyote)] <- 0 
lynx[is.na(lynx)] <- 0 
marten[is.na(marten)] <- 0 
fisher[is.na(fisher)] <- 0 
```

#Load in covariate data

```{r}
climate <- read.csv("data/climatecovars.csv")
hf <- read.csv("data/hfcovars.csv")
```

##Covariate data
```{r}
covars <- bind_cols(climate, hf[,4])

covars<-rename(covars, hf = ...6)

covars$PC1<-scale(covars$PC1)
covars$PC2<-scale(covars$PC2)
covars$hf<-scale(covars$hf)
```

##Single Species Coyote
```{r}
umf_coyote <- unmarkedFrameOccu(
  y = coyote,
  siteCovs = covars
)

mod_coyote <- occu(
  formula = ~1 ~ PC1*hf + PC2*hf, 
  data = umf_coyote,
  method = "BFGS"
)

summary(mod_coyote)

plotEffects(mod_coyote, type = "state", covariate = "hf")
plotEffects(mod_coyote, type = "state", covariate = "PC1")
plotEffects(mod_coyote, type = "state", covariate = "PC2")
```


```{r}
pc2data_lohf <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 1000),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.25, na.rm = TRUE)
)

pc2data_hihf <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 1000),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.75, na.rm = TRUE)
)

pred_coyote_pc2_lohf <- predict(
  mod_coyote,
  type = "state",
  species = "coyote",
  newdata = pc2data_lohf
)

pred_coyote_pc2_hihf <- predict(
  mod_coyote,
  type = "state",
  species = "coyote",
  newdata = pc2data_hihf
)

df_pc2_coyote <- data.frame(
  cov = pc2data_lohf$PC2,
  pred_lo = pred_coyote_pc2_lohf$Predicted,
  lower_lo = pred_coyote_pc2_lohf$lower,
  upper_lo = pred_coyote_pc2_lohf$upper,
  pred_hi = pred_coyote_pc2_hihf$Predicted,
  lower_hi = pred_coyote_pc2_hihf$lower,
  upper_hi = pred_coyote_pc2_hihf$upper
)

hf_labels <-  c(pred_lo = "darkgreen", pred_hi = "darkorange3")

coyote_pc2 <- ggplot(df_pc2_coyote, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_lo, ymax = upper_lo), fill = "darkgreen", alpha = 0.2) +
  geom_line(aes(y = pred_lo), color = "darkgreen", linewidth = 1) +
  geom_ribbon(aes(ymin = lower_hi, ymax = upper_hi), fill = "darkorange3", alpha = 0.2) +
  geom_line(aes(y = pred_hi), color = "darkorange3", linewidth= 1) +
  scale_color_manual(values = hf_labels) +
  labs(y = "Coyote occupancy probability",
       x = "Climate PC2",
       title = "Coyote occupancy",
       colors = "Human footprint")+
  theme_classic()

coyote_pc2
```

```{r}
pc2data_lohf <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 1000),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.25, na.rm = TRUE)
)

pc2data_hihf <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 1000),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.75, na.rm = TRUE)
)
```

##Single Species Lynx
```{r}
umf_canlynx <- unmarkedFrameOccu(
  y = lynx,
  siteCovs = covars
)

mod_canlynx <- occu(
  formula = ~1 ~PC1*hf + PC2*hf, 
  data = umf_canlynx,
  method = "BFGS"
)

summary(mod_canlynx)

plotEffects(mod_canlynx, type = "state", covariate = "hf")
plotEffects(mod_canlynx, type = "state", covariate = "PC1")
plotEffects(mod_canlynx, type = "state", covariate = "PC2")
```
##Single Species Marten
```{r}
umf_marten <- unmarkedFrameOccu(
  y = marten,
  siteCovs = covars
)

mod_marten <- occu(
  formula = ~1 ~PC1 + PC2 + hf, 
  data = umf_marten,
  method = "BFGS"
)

summary(mod_marten)

plotEffects(mod_marten, type = "state", covariate = "hf")
plotEffects(mod_marten, type = "state", covariate = "PC1")
plotEffects(mod_marten, type = "state", covariate = "PC2")
```
##Single Species Fisher
```{r}
umf_fisher <- unmarkedFrameOccu(
  y = fisher,
  siteCovs = covars
)

mod_fisher <- occu(
  formula = ~1 ~PC1 + PC2 + hf, 
  data = umf_fisher,
  method = "BFGS"
)

summary(mod_fisher)

plotEffects(mod_fisher, type = "state", covariate = "hf")
plotEffects(mod_fisher, type = "state", covariate = "PC1")
plotEffects(mod_fisher, type = "state", covariate = "PC2")
```

##Occumulti approach - coyote lynx only
```{r}
ylist_lynx <- list(coyote = coyote, lynx = lynx)

ylist_lynx$coyote[is.na(ylist_lynx$coyote)] <- 0
ylist_lynx$lynx[is.na(ylist_lynx$lynx)] <- 0

umf_lynx <- unmarkedFrameOccuMulti(y = ylist_lynx, siteCovs = covars)

stateformulas_null <- c("~1", "~1", "~1")
detformulas_null <-  c("~1", "~1")

stateformulas_lynx <- c("~PC1 + hf", "~PC1 + hf", "~PC1 + hf")
detformulas_lynx <-  c("~1", "~1")

mod_null <- occuMulti(
  detformulas = detformulas_null,
  stateformulas = stateformulas_null,
  data = umf_lynx,
  method = "BFGS",
  se =TRUE
)

mod_lynx <- occuMulti(
  detformulas = detformulas_lynx,
  stateformulas = stateformulas_lynx,
  data = umf_lynx,
  method = "BFGS",
  se =TRUE
)


summary(mod_lynx)
coef(mod_lynx)
SE(mod_lynx)             # standard errors
confint(mod_lynx, type = "state")        # confidence intervals
```

```{r}
# 1. helper functions
logit <- function(p) qlogis(pmax(pmin(p, 0.999), 0.001))

# 2. calculate naive occupancy/detection from your matrices (replace y1,y2 and n_surveys)
psi_hat1 <- mean(rowSums(coyote) > 0)     # coyote
psi_hat2 <- mean(rowSums(lynx) > 0)     # lynx
p_hat1   <- mean(rowSums(coyote)[rowSums(coyote)>0] / ncol(coyote), na.rm = TRUE)
p_hat2   <- mean(rowSums(lynx)[rowSums(lynx)>0] / ncol(lynx), na.rm = TRUE)
p_hat1[is.na(p_hat1)] <- 0.05
p_hat2[is.na(p_hat2)] <- 0.05

# 3. Create a named vector matching full_names
starts_named <- setNames(rep(0, length(full_names)), full_names)

# Now fill sensible values for things we recognise in the names
# Example name patterns you might see (inspect full_names to adapt):
# "[coyote] (Intercept)", "[coyote] hf", "[lynx] (Intercept)", "[lynx] hf",
# "[coyote:lynx] (Intercept)", "[coyote:lynx] hf", "[coyote] p(Intercept)", etc.
# Below uses grepl to detect substrings — adapt to your actual names

# occupancy intercepts
if(any(grepl("\\[coyote\\].*Intercept", full_names))){
  starts_named[grepl("\\[coyote\\].*Intercept", full_names)] <- logit(psi_hat1)
}
if(any(grepl("\\[lynx\\].*Intercept", full_names))){
  starts_named[grepl("\\[lynx\\].*Intercept", full_names)] <- logit(psi_hat2)
}

# detection intercepts (often named in 'det' part; inspect exact pattern in full_names)
if(any(grepl("\\[coyote\\].*p\\(Intercept\\)|\\[coyote\\] p.*Intercept", full_names))){
  starts_named[grepl("\\[coyote\\].*p\\(Intercept\\)|\\[coyote\\] p.*Intercept", full_names)] <- logit(p_hat1)
} else if(any(grepl("\\[coyote\\] \\(Intercept\\)\\.p", full_names))){ 
  # alternate naming schemes — inspect and adapt
  starts_named[grepl("\\[coyote\\] \\(Intercept\\)\\.p", full_names)] <- logit(p_hat1)
}

if(any(grepl("\\[lynx\\].*p\\(Intercept\\)|\\[lynx\\] p.*Intercept", full_names))){
  starts_named[grepl("\\[lynx\\].*p\\(Intercept\\)|\\[lynx\\] p.*Intercept", full_names)] <- logit(p_hat2)
}

# interaction parameters -> set to small value (0 or 0.01)
if(any(grepl("coyote:lynx", full_names) | grepl("lynx:coyote", full_names))){
  starts_named[grepl("coyote:lynx", full_names) | grepl("lynx:coyote", full_names)] <- 0.0
}

# slopes: leave zeros (or put small values) — already zero by default

# Final numeric vector to pass to occuMulti (remove names)
start_vals <- unname(starts_named)
```

##Conditional occupancy lynx given coyote
```{r}
lynxocond_data <- data.frame(
  PC1 = mean(covars$PC1, na.rm = TRUE),
  PC2 = mean(covars$PC2, na.rm = TRUE),
  hf = mean(covars$hf, na.rm = TRUE)
)

pred_lynx_present <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = lynxocond_data
)

pred_lynx_absent <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",
  newdata = lynxocond_data
)

df_lynxcond <- data.frame(
  coyote =  c("Present", "Absent"),
  est = c(pred_lynx_present$Predicted, pred_lynx_absent$Predicted),
  lower = c(pred_lynx_present$lower, pred_lynx_absent$lower),
  upper = c(pred_lynx_present$upper, pred_lynx_absent$upper)
)

lynxcond_plot <- ggplot(df_lynxcond, aes(x = coyote, y = est))+
  geom_point()+
  geom_errorbar(aes(ymin = lower, ymax = upper, width = 0.1))+
  labs(x = "Coyote occupancy status",
       y = "Conditional occupancy of lynx",
       title = "Lynx occupancy conditional on coyote presence")+
  ylim(0,1)+
  theme_classic()

lynxcond_plot
```

##Conditional occupancy coyote given lynx
```{r}
pred_coyote_present <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "lynx",
  newdata = lynxocond_data
)

pred_coyote_absent <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "-lynx",
  newdata = lynxocond_data
)

df_coyotecond <- data.frame(
  lynx =  c("Present", "Absent"),
  est = c(pred_coyote_present$Predicted, pred_coyote_absent$Predicted),
  lower = c(pred_coyote_present$lower, pred_coyote_absent$lower),
  upper = c(pred_coyote_present$upper, pred_coyote_absent$upper)
)

coyotecond_plot <- ggplot(df_coyotecond, aes(x = lynx, y = est))+
  geom_point()+
  geom_errorbar(aes(ymin = lower, ymax = upper, width = 0.1))+
  labs(x = "Lynx occupancy status",
       y = "Conditional occupancy of coyote",
       title = "Coyote occupancy conditional on lynx presence")+
  ylim(0,1)+
  theme_classic()

coyotecond_plot
```
##Conditional occupancy lynx given coyote Climate pc1

Plot low footprint vs high footprint for each climate variable. 
```{r}
##Climate PC1 low human footprint

pc1data_lohf <- data.frame(
  PC1 = seq(min(covars$PC1, na.rm = TRUE),
           max(covars$PC1, na.rm = TRUE),
           length.out = 1000),
  PC2 = mean(covars$PC2, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.25, na.rm = TRUE)
)

# helper: smooth any boundary curve
smooth_bounds <- function(x, y, k = 10) {
  gamfit <- gam(y ~ s(x, k = k))
  predict(gamfit, newdata = data.frame(x = x))
}

# Lynx occupancy given coyote present
pred_lynx_present_pc1_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc1data_lohf
)

# Lynx occupancy given coyote absent
pred_lynx_absent_pc1_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = pc1data_lohf
)

df_pc1_lohf <- data.frame(
  cov = pc1data_lohf$PC1,
  present = pred_lynx_present_pc1_lohf$Predicted,
  lower_present = pred_lynx_present_pc1_lohf$lower,
  upper_present = pred_lynx_present_pc1_lohf$upper,
  absent = pred_lynx_absent_pc1_lohf$Predicted,
  lower_absent = pred_lynx_absent_pc1_lohf$lower,
  upper_absent = pred_lynx_absent_pc1_lohf$upper
)


lynxcoyote_pc1_lohf <- ggplot(df_pc1_lohf, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Climate PC1",
       title = "Lynx occupancy conditional on coyote (lo hf)") +
  theme_classic()

lynxcoyote_pc1_lohf
```

```{r}
##Climate PC1 hi human footprint

pc1data_hihf <- data.frame(
  PC1 = seq(min(covars$PC1, na.rm = TRUE),
           max(covars$PC1, na.rm = TRUE),
           length.out = 1000),
  PC2 = mean(covars$PC2, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.75, na.rm = TRUE)
)


# Lynx occupancy given coyote present
pred_lynx_present_pc1_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc1data_hihf
)

# Lynx occupancy given coyote absent
pred_lynx_absent_pc1_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = pc1data_hihf
)

df_pc1_hihf <- data.frame(
  cov = pc1data_hihf$PC1,
  present = pred_lynx_present_pc1_hihf$Predicted,
  lower_present = pred_lynx_present_pc1_hihf$lower,
  upper_present = pred_lynx_present_pc1_hihf$upper,
  absent = pred_lynx_absent_pc1_hihf$Predicted,
  lower_absent = pred_lynx_absent_pc1_hihf$lower,
  upper_absent = pred_lynx_absent_pc1_hihf$upper
)


lynxcoyote_pc1_hihf <- ggplot(df_pc1_hihf, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Climate PC1",
       title = "Lynx occupancy conditional on coyote (hi hf)")+
  theme_classic()

lynxcoyote_pc1_hihf
```

##Conditional occupancy lynx given coyote Climate pc2
```{r}
##Climate PC2 low human footprint

pc2data_lohf <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 1000),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.25, na.rm = TRUE)
)


# Lynx occupancy given coyote present
pred_lynx_present_pc2_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc2data_lohf
)

# Lynx occupancy given coyote absent
pred_lynx_absent_pc2_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = pc2data_lohf
)

df_pc2_lohf <- data.frame(
  cov = pc2data_lohf$PC2,
  present = pred_lynx_present_pc2_lohf$Predicted,
  lower_present = pred_lynx_present_pc2_lohf$lower,
  upper_present = pred_lynx_present_pc2_lohf$upper,
  absent = pred_lynx_absent_pc2_lohf$Predicted,
  lower_absent = pred_lynx_absent_pc2_lohf$lower,
  upper_absent = pred_lynx_absent_pc2_lohf$upper
)

df_pc2_lohf$upper_present_smooth <- smooth_bounds(df_pc2_lohf$cov, df_pc2_lohf$upper_present)
df_pc2_lohf$lower_present_smooth <- smooth_bounds(df_pc2_lohf$cov, df_pc2_lohf$lower_present)
df_pc2_lohf$upper_absent_smooth <- smooth_bounds(df_pc2_lohf$cov, df_pc2_lohf$upper_absent)
df_pc2_lohf$lower_absent_smooth <- smooth_bounds(df_pc2_lohf$cov, df_pc2_lohf$lower_absent)

lynxcoyote_pc2_lohf <- ggplot(df_pc2_lohf, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Climate PC2",
       title = "Lynx occupancy conditional on coyote (lo hf)")+
  theme_classic()

lynxcoyote_pc2_lohf
```

```{r}
##Climate PC2 hi human footprint

pc2data_hihf <- data.frame(
  PC2 = seq(min(covars$PC2, na.rm = TRUE),
           max(covars$PC2, na.rm = TRUE),
           length.out = 1000),
  PC1 = mean(covars$PC1, na.rm = TRUE),  # fix other covariates
  hf = quantile(covars$hf, 0.75, na.rm = TRUE)
)


# Lynx occupancy given coyote present
pred_lynx_present_pc2_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "coyote",
  newdata = pc2data_hihf
)

# Lynx occupancy given coyote absent
pred_lynx_absent_pc2_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "lynx",
  cond = "-coyote",   # the minus sign = species absent
  newdata = pc2data_hihf
)

df_pc2_hihf <- data.frame(
  cov = pc2data_hihf$PC2,
  present = pred_lynx_present_pc2_hihf$Predicted,
  lower_present = pred_lynx_present_pc2_hihf$lower,
  upper_present = pred_lynx_present_pc2_hihf$upper,
  absent = pred_lynx_absent_pc2_hihf$Predicted,
  lower_absent = pred_lynx_absent_pc2_hihf$lower,
  upper_absent = pred_lynx_absent_pc2_hihf$upper
)


lynxcoyote_pc2_hihf <- ggplot(df_pc2_hihf, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Lynx occupancy probability",
       x = "Climate PC2",
       title = "Lynx occupancy conditional on coyote (hihf)")+
  theme_classic()

lynxcoyote_pc2_hihf
```

```{r}

##Multi panel plot of lynx-coyote
grid.arrange(lynxcoyote_pc1_lohf, lynxcoyote_pc2_lohf, lynxcoyote_pc1_hihf, lynxcoyote_pc2_hihf, nrow = 2)
```



##Coyote occupancy from multi-species model. 
```{r}
##Climate PC1 low human footprint (coyote)

pred_coyote_present_pc1_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "lynx",
  newdata = pc1data_lohf
)

pred_coyote_absent_pc1_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "-lynx",
  newdata = pc1data_lohf
)

df_pc1_lohf_coyote <- data.frame(
  cov = pc1data_lohf$PC1,
  present = pred_coyote_present_pc1_lohf$Predicted,
  lower_present = pred_coyote_present_pc1_lohf$lower,
  upper_present = pred_coyote_present_pc1_lohf$upper,
  absent = pred_coyote_absent_pc1_lohf$Predicted,
  lower_absent = pred_coyote_absent_pc1_lohf$lower,
  upper_absent = pred_coyote_absent_pc1_lohf$upper
)


coyotelynx_pc1_lohf <- ggplot(df_pc1_lohf_coyote, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Coyote absent probability",
       x = "Climate PC1",
       title = "Coyote occupancy (lo human footprint)")+
  theme_classic()

coyotelynx_pc1_lohf
```


```{r}
##Climate PC1 hi human footprint (coyote)

pred_coyote_present_pc1_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "lynx",
  newdata = pc1data_hihf
)

pred_coyote_absent_pc1_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "-lynx",
  newdata = pc1data_hihf
)


df_pc1_hihf_coyote <- data.frame(
  cov = pc1data_hihf$PC1,
  present = pred_coyote_present_pc1_hihf$Predicted,
  lower_present = pred_coyote_present_pc1_hihf$lower,
  upper_present = pred_coyote_present_pc1_hihf$upper,
  absent = pred_coyote_absent_pc1_hihf$Predicted,
  lower_absent = pred_coyote_absent_pc1_hihf$lower,
  upper_absent = pred_coyote_absent_pc1_hihf$upper
)


coyotelynx_pc1_hihf <- ggplot(df_pc1_hihf_coyote, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Coyote occupancy probability",
       x = "Climate PC1",
       title = "Coyote occupancy (hi human footprint)")+
  theme_classic()

coyotelynx_pc1_hihf
```
```{r}
##Climate PC2 low human footprint (coyote)

pred_coyote_present_pc2_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "lynx",
  newdata = pc2data_lohf
)

pred_coyote_absent_pc2_lohf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "-lynx",
  newdata = pc2data_lohf
)

df_pc2_lohf_coyote <- data.frame(
  cov = pc2data_lohf$PC2,
  present = pred_coyote_present_pc2_lohf$Predicted,
  lower_present = pred_coyote_present_pc2_lohf$lower,
  upper_present = pred_coyote_present_pc2_lohf$upper,
  absent = pred_coyote_absent_pc2_lohf$Predicted,
  lower_absent = pred_coyote_absent_pc2_lohf$lower,
  upper_absent = pred_coyote_absent_pc2_lohf$upper
)


coyotelynx_pc2_lohf <- ggplot(df_pc2_lohf_coyote, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
  geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Coyote occupancy probability",
       x = "Climate PC2",
       title = "Coyote occupancy (lo human footprint)")+
  theme_classic()

coyotelynx_pc2_lohf
```
```{r}
##Climate PC2 hi human footprint (coyote)

pred_coyote_present_pc2_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "lynx",
  newdata = pc2data_hihf
)

pred_coyote_absent_pc2_hihf <- predict(
  mod_lynx,
  type = "state",
  species = "coyote",
  cond = "-lynx",
  newdata = pc2data_hihf
)

df_pc2_hihf_coyote <- data.frame(
  cov = pc2data_hihf$PC2,
  present = pred_coyote_present_pc2_hihf$Predicted,
  lower_present = pred_coyote_present_pc2_hihf$lower,
  upper_present = pred_coyote_present_pc2_hihf$upper,
  absent = pred_coyote_absent_pc2_hihf$Predicted,
  lower_absent = pred_coyote_absent_pc2_hihf$lower,
  upper_absent = pred_coyote_absent_pc2_hihf$upper
)


coyotelynx_pc2_hihf <- ggplot(df_pc2_hihf_coyote, aes(x = cov)) +
  geom_ribbon(aes(ymin = lower_present, ymax = upper_present), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = present), color = "blue") +
   geom_ribbon(aes(ymin = lower_absent, ymax = upper_absent), fill = "red", alpha = 0.2) +
  geom_line(aes(y = absent), color = "red") +
  labs(y = "Coyote occupancy probability",
       x = "Climate PC2",
       title = "Coyote occupancy (hi human footprint)")+
  theme_classic()

coyotelynx_pc2_hihf
```

```{r}

##Multi panel plot of lynx-coyote
grid.arrange(coyotelynx_pc1_lohf, coyotelynx_pc2_lohf, coyotelynx_pc1_hihf, coyotelynx_pc2_hihf, nrow = 2)
```

##Occumulti approach - all species
```{r}
ylist <- list(coyote = coyote, lynx = lynx, marten = marten,  fisher = fisher)

ylist$coyote[is.na(ylist$coyote)] <- 0
ylist$lynx[is.na(ylist$lynx)] <- 0
ylist$marten[is.na(ylist$marten)] <- 0
ylist$fisher[is.na(ylist$fisher)] <- 0

lapply(ylist, head)
```


```{r}
umf <- unmarkedFrameOccuMulti(y = ylist, siteCovs = covars)
```

```{r}
umf@fDesign

colnames(umf@fDesign)

stateformulas <- c("~1", "~1", "~1", "~1", "~1", "~1", "~1", "0", "0", "0", "0", "0", "0", "0", "0")

detformulas <- c("~1","~1","~1", "~1")

start_vals <- rep(0.5, 8)

y_mat <- do.call(cbind, lapply(ylist, rowSums))
cor(y_mat > 0)

```

```{r}
mod_null <- occuMulti(detformulas = detformulas, stateformulas = stateformulas, data = umf, method = "BFGS", se = TRUE)
summary(mod_null)
```
```{r}
umf@fDesign

colnames(umf@fDesign)

clim1_phi <- c("~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "~scale(PC1)", "0", "0", "0", "0", "0", "0", "0", "0")

clim1_p <- c("~1","~1","~1", "~1")

start_vals <- rep(0.5, 8)

y_mat <- do.call(cbind, lapply(ylist, rowSums))
cor(y_mat > 0)

```

```{r}
mod_clim1 <- occuMulti(detformulas = clim1_p, stateformulas = clim1_phi, data = umf, method = "BFGS", se = TRUE)
summary(mod_clim1)
```

```{r}
occ_prob <- predict(mod_null, type="state")
```
##Bayesian Model
```{stan}
data {
  int<lower=1> N;           // number of sites
  int<lower=1> T;           // number of occasions
  int<lower=0,upper=1> y1[N, T];  // detections for species 1 (Coyote)
  int<lower=0,upper=1> y2[N, T];  // detections for species 2 (Lynx)
}

parameters {
  real<lower=0, upper=1> psi1;  // occupancy probability for Coyote
  real<lower=0, upper=1> psi2;  // occupancy probability for Lynx
  real<lower=0, upper=1> p1;    // detection probability for Coyote
  real<lower=0, upper=1> p2;    // detection probability for Lynx
}

transformed parameters {
  // none needed for basic model
}

model {
  // priors
  psi1 ~ beta(1,1);
  psi2 ~ beta(1,1);
  p1   ~ beta(1,1);
  p2   ~ beta(1,1);

  // likelihood
  for (i in 1:N) {
    // Coyote
    target += bernoulli_lpmf(max(y1[i,]) | psi1);  // occupancy contribution
    for (t in 1:T) {
      target += bernoulli_lpmf(y1[i,t] | p1 * psi1);
    }
    // Lynx
    target += bernoulli_lpmf(max(y2[i,]) | psi2);
    for (t in 1:T) {
      target += bernoulli_lpmf(y2[i,t] | p2 * psi2);
    }
  }
}

```

```{r}
# Replace NAs with 0 for y matrices (Stan cannot store NA) 
y1_clean <- coyote
y2_clean <- lynx
is_obs1 <- ifelse(is.na(y1_clean), 0, 1)
is_obs2 <- ifelse(is.na(y2_clean), 0, 1)
y1_clean[is.na(y1_clean)] <- 0
y2_clean[is.na(y2_clean)] <- 0

stan_data <- list(
  N = nrow(y1_clean),
  T = ncol(y1_clean),
  y1 = y1_clean,
  y2 = y2_clean,
  is_obs1 = is_obs1,
  is_obs2 = is_obs2
)

```

```{r}
library(rstan)

fit <- stan(
  file = "two_species_latent.stan",
  data = stan_data,
  chains = 4,
  iter = 2000
)

print(fit, pars=c("psi1","psi2","p1","p2"))


```

```{r}
for(sp in names(ylist_null)){
  cat("\nSpecies:", sp, "\n")
  mat <- ylist[[sp]]
  cat("Total detections:", sum(mat, na.rm=TRUE), "\n")
  cat("Number of sites with all zeros:", sum(rowSums(mat, na.rm=TRUE) == 0), "\n")
  cat("Number of sites with all ones:", sum(rowSums(mat, na.rm=TRUE) == ncol(mat)), "\n")
}

y1 <- matrix(c(1,0,0,1,0,1,0,0), nrow=4)
y2 <- matrix(c(0,1,0,1,0,0,1,0), nrow=4)
umf_test <- unmarkedFrameOccuMulti(y = list(Coyote=y1, Lynx=y2))
fit <- occuMulti(detformulas=c("~1","~1"), stateformulas=c("~1","~1","~1"), data=umf_test)
```

```{r}

# CREATING DESIGN MATRIX
X.array <- array(0, dim = c(nrow(coyote), 16, 32))

clim <- scale(psi.cov$MCMT)[, 1]
hf <- scale(psi.cov$RoadHardSurface_buf)[, 1]
lati <- scale(psi.cov$Latitude)[, 1]
long <- scale(psi.cov$Longitude)[, 1]
lbyl <- lati * long
hike <- scale(psi.cov$People_site * 1000 / cday)

# importing the general form of the design matrix
library(xlsx)
dm <- read.xlsx('Design Matrix.xlsx', 3, rowIndex = 3:18, colIndex = 2:33,
                header = F)

# filling in the design matrix
for(i in 1:nrow(coyote)){
  for(j in 1:15){
    X.array[i, j, dm[j, ] == 1] <-
      c(1, lati[i], long[i], lbyl[i], hike[i],
        1, lati[i], long[i], lbyl[i], hden[i],
        1, lati[i], long[i], lbyl[i], hden[i],
        1, lati[i], long[i], lbyl[i], hike[i],
        1, d5km[i],
        1, hden[i],
        1, hden[i],
        1, d5km[i],
        1, hden[i],
        1, d5km[i])[dm[j, ] == 1]
  }
}


# OBSERVED Y
y1max <- apply(coyote, 1, max, na.rm = T)
y2max <- apply(lynx, 1, max, na.rm = T)
y3max <- apply(marten, 1, max, na.rm = T)
y4max <- apply(fisher, 1, max, na.rm = T)

# Vectorizing detection / non-detection
Y1 <- Y2 <- Y3 <- Y4 <- trail <- dd <- numeric()
for(i in 1:nrow(bobcat)){
  Y1 <- c(Y1, bobcat[i, 1:cday[i]])
  Y2 <- c(Y2, coyote[i, 1:cday[i]])
  Y3 <- c(Y3, gryfox[i, 1:cday[i]])
  Y4 <- c(Y4, redfox[i, 1:cday[i]])
  trail <- c(trail, rep(psi.cov$Trail[i], cday[i]))
  dd <- c(dd, rep(p.cov$Det_dist[i], cday[i]))
}

# Stan does not support ragged indexing.  This is a work-around
start <- 1
for(i in 2:nrow(bobcat)){
  start <- c(start, sum(cday[1:(i - 1)]) + 1)
}

data <- list(
  K = ncol(X.array[1, , ]),
  L = 3,
  N = nrow(bobcat),
  NJ = length(Y1),
  S = 16,
  obs = cday,
  start = start,
  x = X.array,
  trl = trail,
  dd = scale(dd)[, 1],
  I1 = y1max, I2 = y2max, I3 = y3max, I4 = y4max,
  Y1 = Y1, Y2 = Y2, Y3 = Y3, Y4 = Y4
  )

inits <- function(){
  list(
    a1 = rnorm(3),
    a2 = rnorm(3),
    a3 = rnorm(3),
    a4 = rnorm(3),
    beta = rnorm(ncol(X.array[1, , ])))
}

params <- c('a1', 'a2', 'a3', 'a4', 'beta', 'll')

```


```{r}
```
