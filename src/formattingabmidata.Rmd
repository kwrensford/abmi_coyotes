---
title: "formattingabmidata"
output: html_document
editor: visual 
editor_options: 
  chunk_output_type: console
---

```{r}
library(vroom)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggfortify)
library(forcats)
library(lubridate)
library(unmarked)
library(camtrapR)
library(overlap)
library(ggmap)
library(reshape2)
library(corrplot)
library(terra)
library(mapview)
library(sf)
library(exactextractr)
library(xml2)
library(arcgislayers)
library(geodata)
```

##Load in and format camera data

```{r}
# Camera Reports
all_main_reports <- vroom::vroom("data/ABMI EH 2014-2019 Main Reports.csv")
all_image_reports <- vroom::vroom("data/ABMI EH 2014-2019 Image Reports.csv")

camlocations <- all_main_reports %>%
  distinct(location, .keep_all = TRUE)

##Create column for year of report
all_main_reports$year <- lubridate::year(all_main_reports$image_date_time)
all_image_reports$year <- lubridate::year(all_image_reports$image_date_time)

##Create column for month
all_main_reports$month <- lubridate::month(all_main_reports$image_date_time)
all_image_reports$month <- lubridate::month(all_image_reports$image_date_time)

##Filter reports to 2015-2019 range
study_image_reports<-all_image_reports %>%
  filter(year > 2014 & year < 2020)

study_main_reports<-all_main_reports %>%
  filter(year > 2014 & year < 2020)

##Filter to Apr - July for closure

study_main_reports<-study_main_reports %>%
  filter(month > 3 & month < 8)

study_image_reports<-study_image_reports %>%
  filter(month > 3 & month < 8)

##Filter data for only mesos
study_main_reports <- study_main_reports %>%
  filter(species_common_name == "Coyote" 
         | species_common_name == "Canada Lynx" 
         | species_common_name == "Marten"
         | species_common_name == "Fisher")


##Segment Data for each Year
main_reports_2015<-all_main_reports%>%
  filter(year==2015)

main_reports_2016<-all_main_reports%>%
  filter(year==2016)

main_reports_2017<-all_main_reports%>%
  filter(year==2017)

main_reports_2018<-all_main_reports%>%
  filter(year==2018)

main_reports_2019<-all_main_reports%>%
  filter(year==2019)

#Camera effort data
total_operation_days<- vroom::vroom("data/Total Days of Operations ABMI EH 2014-2020.csv")

camera_operation_dates <- vroom::vroom("data/Operation Dates ABmi EH 2014-2018.csv")
```

##Covariate data

```{r}
#Load in human footprint dataset, buffered and unbuffered
ehs_humanfootprint<-vroom::vroom("data/Point Level Vegetation HF for Kwasi.csv")
ehs_humanfootprint_buffered<-vroom::vroom("data/150m Buffer Vegetation HF for Kwasi.csv")

#Combine buffered and unbuffered dataset
buffered_renamed <- ehs_humanfootprint_buffered %>%
  rename_with(~ paste0(.x, "_buf"),
              .cols = -location)

ehs_humanfootprint_merged <- ehs_humanfootprint %>%
  left_join(buffered_renamed, by = "location")
```

##Make sure covariate locations match detection locations

```{r}
camlocations <- all_main_reports %>%
  distinct(location, .keep_all = TRUE)

# Join the two datasets by Station
check_coords <- ehs_humanfootprint_merged %>%
  left_join(camlocations %>% dplyr::select(location, latitude_cam = latitude, longitude_cam = longitude),
            by = "location")

# Flag mismatches
check_coords <- check_coords %>%
  mutate(
    lat_mismatch = Lat != latitude_cam,
    lon_mismatch = Long != longitude_cam
  )

# View rows with mismatches
filter(check_coords, lat_mismatch | lon_mismatch)

```

```{r}
covariates_fixed <- check_coords %>%
  mutate(
    Latitude  = ifelse(lat_mismatch, latitude_cam, Lat),
    Longitude = ifelse(lon_mismatch, longitude_cam, Long)
  ) %>%
  dplyr::select(-latitude_cam, -longitude_cam, -lat_mismatch, -lon_mismatch, -Lat, -Long)
```

##Partitioning multi-species data for natural regions only where all four species are detected

```{r}
ggplot(covariates_fixed, aes(x = Longitude, y = Latitude, color = NR)) + 
  theme_minimal()+
  geom_point()

ggplot(covariates_fixed, aes(x = NR, fill = NR)) + 
  theme_minimal()+
  geom_bar()


```

```{r}

study_main_reports <- study_main_reports %>%
  left_join(covariates_fixed %>% dplyr::select(location, NR),
            by = "location")

species_list <- unique(study_main_reports$species_common_name)

regions_with_all <- study_main_reports %>%
  group_by(NR) %>%
  summarise(species_present = list(unique(species_common_name))) %>%
  filter(all(species_list %in% species_present)) %>%
  pull(NR)

detections_filtered <- study_main_reports %>%
  filter(NR %in% regions_with_all)

detections_summary <- study_main_reports %>%
  group_by(NR, species_common_name) %>%
  summarise(count = n(), .groups = "drop")


ggplot(detections_summary, aes(x = NR, y = count, fill = species_common_name)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Species detections by natural region",
       x = "Natural region",
       y = "Number of detections",
       fill = "Species") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

study_main_reports <- study_main_reports %>%
  filter(NR == "Boreal")
```

##Create detection matrices for each species

```{r}
# camtrapR occupancy modeling workflow

#Filter study image reports to locations in filtered main reports
study_camlocations <- unique(study_main_reports$location)

study_image_reports <- study_image_reports %>%
  filter(location %in% study_camlocations)

##Use image reports file to extract camera operation dates for each location
camera_operation_dates_v2<-study_image_reports %>%
  group_by(year, project_id, location) %>%
  summarize(
    start_date_time = min(image_date_time),
    end_date_time = max(image_date_time)
  )
##Camera operation matrix
camera_operation_dates_filtered<-camera_operation_dates_v2%>%
  filter(!is.na(start_date_time))

#camera_operation_dates_filtered<-camera_operation_dates_filtered%>%
#  mutate(start_date_time = as.character(start_date_time))%>%
 # mutate(end_date_time = as.character(end_date_time))

##Start and end dates for deployments per year
camera_deployment_dates<-camera_operation_dates_filtered %>%
  group_by(location, year)%>%
  summarize(
    start_date_time = min(start_date_time),
    end_date_time = max (end_date_time),
    .groups = "drop"
  )

##Idenitfy gaps or periods of inactivity within a camera's deployment "problems"
problem_matrix <-camera_operation_dates_filtered%>%
  arrange(location, year, start_date_time)%>%
  group_by(location, year)%>%
  mutate(
    Problem1_from = lag(end_date_time) + 1,
    Problem1_to = start_date_time -1
  ) %>%
  filter(!is.na(Problem1_from)& Problem1_from <= Problem1_to)%>%
  dplyr::select(location, year, Problem1_from, Problem1_to)

##Combine problems with deployment data
camera_deployment_problems<-camera_deployment_dates%>%
  left_join(problem_matrix, by = c("location", "year"))%>%
              arrange(location, year, start_date_time, Problem1_from)

##Convert dates to character to be compatible with camptrapR
#camera_deployment_problems<-camera_deployment_problems%>%
#  mutate(start_date_time = as.character(start_date_time))%>%
#  mutate(end_date_time = as.character(end_date_time))

##Filter cameras where start and end time are identical
camera_deployment_problems<-camera_deployment_problems%>%
  filter(start_date_time != end_date_time)

#Build a camera operation matrix to fill with detections
camera_operation_matrix<-cameraOperation(camera_deployment_problems,
                                         stationCol = "location",
                                         sessionCol = "year",
                                         setupCol = "start_date_time",
                                         retrievalCol = "end_date_time",
                                         writecsv = FALSE,
                                         hasProblems = FALSE,
                                         dateFormat = "ymd_HMS"
                                         )
##Camera detection history
datetime_check<-as.POSIXct(study_main_reports$image_date_time, format = ymd_HMS)
invalid_entries<-study_main_reports[is.na(datetime_check),]
invalid_entries

###Daylight savings time!! 4 coyote observations fall in the DST hour, so shifting to 3:00 to compensate (I'll figure out a more elegant way to do this later)

##entries 255396,255397,1882366,7326233

#study_main_reports[255396,9] <- as.POSIXct("2015-03-08 3:03:29", format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
#study_main_reports[255397,9]<- as.POSIXct("2015-03-08 3:03:49", format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
#study_main_reports[1882366,9]<- as.POSIXct("2015-03-08 3:00:01", format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
#study_main_reports[7326233,9]<- as.POSIXct("2018-03-11 3:15:00", format = "%Y-%m-%d %H:%M:%S", tz = "UTC")

##Create detection tables for each focal species with a week  long (7 day) occasion length

##Coyote
coyotedetectionhistory<-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Coyote",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )

coyotedetections<-coyotedetectionhistory$detection_history

##Lynx
lynxdetectionhistory<-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Canada Lynx",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )
lynxdetections<-lynxdetectionhistory$detection_history


##Marten
martendetectionhistory<-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Marten",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )
martendetections<-martendetectionhistory$detection_history


##Fisher
fisherdetectionhistory<-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Fisher",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )
fisherdetections<-fisherdetectionhistory$detection_history
```

##Abundance counts

```{r}
##Coyote
coyoteabundancehistory <-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         output = "count",
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Coyote",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )

coyoteabundance <-coyotedetectionhistory$detection_history

##Lynx
lynxabundancehistory <- detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Canada Lynx",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )
lynxdetections<-lynxdetectionhistory$detection_history


##Marten
martendetectionhistory<-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Marten",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )
martendetections<-martendetectionhistory$detection_history


##Fisher
fisherdetectionhistory<-detectionHistory(recordTable = study_main_reports,
                                         camOp = camera_operation_matrix,
                                         stationCol = "location",
                                         speciesCol = "species_common_name",
                                         recordDateTimeCol = "image_date_time",
                                         recordDateTimeFormat = "ymd_HMS",
                                         species = "Fisher",
                                         occasionLength = 7,
                                         day1 = "station",
                                         datesAsOccasionNames = FALSE,
                                         includeEffort = TRUE,
                                         scaleEffort = FALSE,
                                         timeZone = "America/Edmonton",
                                         unmarkedMultFrameInput = TRUE
                                         )
fisherdetections<-fisherdetectionhistory$detection_history
```

##Align covariates location names with detection matrix locations (same number and order)

```{r}
covariates_aligned <- covariates_fixed %>%
  filter(location %in% row.names(coyotedetections)) %>%
  arrange(match(location, row.names(coyotedetections)))

# ensure same order
all(row.names(coyotedetections) == covariates_aligned$location)

sites_det <- rownames(coyotedetections)
sites_cov <- covariates_aligned$location

setdiff(sites_det, sites_cov)  # sites in detections but not in covariates
setdiff(sites_cov, sites_det)  # sites in covariates but not in detections

common_sites <- intersect(sites_det, sites_cov)

# filter detections
coyotedetections <- coyotedetections[common_sites, ]
lynxdetections <- lynxdetections[common_sites, ]
martendetections <- martendetections[common_sites, ]
fisherdetections <- fisherdetections[common_sites, ]

coyotedetections <- coyotedetections[rownames(coyotedetections) != "1095-SE",]
lynxdetections <- lynxdetections[rownames(lynxdetections) != "1095-SE",]
martendetections <- martendetections[rownames(martendetections) != "1095-SE",]
fisherdetections <- fisherdetections[rownames(fisherdetections) != "1095-SE",]

# filter covariates
covariates_aligned <- covariates_aligned %>%
  filter(location %in% common_sites) %>%
  arrange(match(location, common_sites))

# Which sites are duplicated?
dup_sites <- covariates_aligned$location[duplicated(covariates_aligned$location)]
dup_sites

# Count how many times each site occurs
table(covariates_aligned$location)

covariates_unique <- covariates_aligned %>%
  distinct(location, .keep_all = TRUE)

identical(rownames(coyotedetections), covariates_unique$location)
identical(rownames(lynxdetections), covariates_unique$location)
identical(rownames(martendetections), covariates_unique$location)
identical(rownames(fisherdetections), covariates_unique$location)
```

##Dimension reduction of climate data

```{r}
## Climate variables
#1) Annual variables:

#Directly calculated annual variables:

#MAT              mean annual temperature (째C),

#MWMT           mean warmest month temperature (째C),

#MCMT            mean coldest month temperature (째C),

#TD                   temperature difference between MWMT and MCMT, or continentality (째C),

#MAP               mean annual precipitation (mm),

#MSP                May to September precipitation (mm),

#AHM  annual heat-moisture index (MAT+10)/(MAP/1000))

#SHM               summer heat-moisture index ((MWMT)/(MSP/1000))

#FFP                Frost free period

#PET                Potential evapotranspiration

##Filter out climate covariates

covariates_climate <- covariates_unique %>%
  dplyr::select(location, Latitude, Longitude, AHM, PET, FFP, MAP, MAT, MWMT, MCMT)

##Keep location info
covar_locations <- covariates_climate %>%
  dplyr::select(location, Latitude, Longitude)

##Climate variables only
climate_var <- covariates_climate %>%
    dplyr::select(-location, -Latitude, -Longitude)

climate_scaled <- scale(climate_var)

##Run PCA
pca_res <- prcomp(climate_scaled, center = TRUE, scale. = TRUE)

plot(pca_res, type = "lines")

summary(pca_res)

biplot(pca_res)


##Extract PC's
climate_pcs <- as.data.frame(pca_res$x[, 1:2])
colnames(climate_pcs) <- c("PC1", "PC2")

# Loadings (variable contributions to PCs)
round(pca_res$rotation[, 1:2], 3)

# Bind with site info
climate_sites <- cbind(covar_locations, climate_pcs)

autoplot(pca_res, data = climate_sites, colour = "Latitude",
         loadings = TRUE, loadings.label = TRUE, loadings.label.size = 3)+
  theme_classic()

# Plot
ggplot(climate_sites, aes(x = PC1, y = PC2, label = location)) +
  geom_point(size = 3, color = "steelblue") +
  geom_text(vjust = -0.5, size = 3) +
  theme_minimal() +
  labs(title = "Sites in PCA Space",
       x = "PC1",
       y = "PC2")+
  theme_minimal()


```

##Dimension reduction of ABMI human footprint data

```{r}

##Filter out humanfootprint covariates
covariates_hf <- covariates_unique %>%
  select(location, Latitude, Longitude, UrbanIndustrial_buf:Canals_buf)

covariates_hf <- covariates_hf %>%
  select(-PeatMine_buf)
##hf variables only
hf_var <- covariates_hf %>%
    select(-location, -Latitude, -Longitude)

hf_var_clean <- na.omit(hf_var)

hf_scaled <- scale(hf_var_clean)

##Run PCA
pca_hf <- prcomp(hf_scaled, center = TRUE, scale. = TRUE)

plot(pca_hf, type = "lines")

summary(pca_hf)

##Extract PC's
hf_pcs <- as.data.frame(pca_hf$x[, 1:2])
colnames(hf_pcs) <- c("PC1", "PC2")

# Loadings (variable contributions to PCs)
round(pca_hf$rotation[, 1:2], 3)

# Bind with site info
hf_sites <- cbind(covar_locations, climate_pcs)

# Plot
ggplot(hf_sites, aes(x = PC1, y = PC2, label = location)) +
  geom_point(size = 3, color = "steelblue") +
  geom_text(vjust = -0.5, size = 3) +
  theme_minimal() +
  labs(title = "Sites in PCA Space",
       x = "PC1",
       y = "PC2")


```

##Canada Human Footprint index

```{r}
library(terra)
library(geodata)

# Load raster (human footprint TIFF) and crop to alberta provincial boundary
hf_raster <- rast("data/chfi/cum_threat2020.02.18.tif")

url <- "https://geospatial.alberta.ca/titan/rest/services/boundary/goa_administrative_area/MapServer/0"

canada <- gadm("Canada", level = 1, path = "data/")
alberta <- canada[canada$NAME_1 == "Alberta", ]
alberta_proj <- project(alberta, hf_raster)

hf_alberta <- crop(hf_raster, alberta_proj)
hf_alberta_masked <- mask(hf_alberta, alberta_proj)

# Convert sites to spatial object
covar_locations <- covar_locations %>%
  filter(!is.na(Longitude) & !is.na(Latitude))

sites_hf <- st_as_sf(covar_locations, coords = c("Longitude", "Latitude"), crs = 4326)
sites_hf <- st_transform(sites_hf, crs(hf_alberta_masked))
sites_vect <- vect(sites_hf)

plot(hf_alberta_masked)
points(sites_vect, col = "")

buffers <- st_buffer(sites_hf, dist = 5000)
buffers_vect <- vect(buffers)

hf_vals <- terra::extract(hf_alberta_masked, buffers_vect, fun = mean, na.rm = TRUE)

covar_locations_hf <- bind_cols(covar_locations, hf_vals[,-1])

climate_sites <- climate_sites %>%
  filter(location != ("1095-SE"))
```

#Write CSV files

```{r}
write.csv(covariates_unique, file = "data/ehscovars.csv", row.names = FALSE)
write.csv(climate_sites, file = "data/climatecovars.csv", row.names = FALSE)
write.csv(covar_locations_hf, file = "data/hfcovars.csv", row.names = FALSE)

write.csv(coyotedetections, file = "data/coyotedetections.csv", row.names = FALSE)
write.csv(lynxdetections, file = "data/lynxdetections.csv", row.names = FALSE)
write.csv(martendetections, file = "data/martendetections.csv", row.names = FALSE)
write.csv(fisherdetections, file = "data/fisherdetections.csv", row.names = FALSE)
```
