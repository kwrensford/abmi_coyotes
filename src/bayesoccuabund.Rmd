---
title: "Abundance Modelling"
author: "Kwasi Wrensford"
date: "2025-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
library(vroom)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(lubridate)
library(MASS)
library(hms)
library(unmarked)
library(camtrapR)
library(overlap)
library(stars)
library(sf)
library(terra)
library(rstan)
library(Rcpp)
library(stringr)
library(mgcv)
library(cowplot)
library(gridExtra)
library(ubms)
```

```{r}
getwd()
```

#Formatting count data

```{r}
getwd()
coyote <- as.matrix(read.csv("data/coyotedetections.csv"))
coyotecounts <- as.matrix(read.csv("data/coyotecounts.csv"))


coyote[is.na(coyote)] <- 0 
```

#Load in covariate data

```{r}
climate <- read.csv("data/climatecovars.csv")
hf <- read.csv("data/hfcovars.csv")
```

```{r}
covars <- bind_cols(climate, hf[,4])

covars<-rename(covars, hf = ...6)

covars$PC1<-scale(covars$PC1)
covars$PC2<-scale(covars$PC2)
covars$hf<-scale(covars$hf)
```

##Frequentist N-mixture in unmarked
```{r}
umf_coyote <- unmarkedFramePCount(
  y = coyotecounts,
  siteCovs = covars
)

coyote_nmix <- pcount(
formula = ~ 1 ~ 
  PC1 * hf + PC2 * hf,
data = umf_coyote,
mixture = "P"
)

coyote_nmix
plotEffects(coyote_nmix, type = "state", covariate = "PC1")
plotEffects(coyote_nmix, type = "state", covariate = "PC2")
plotEffects(coyote_nmix, type = "state", covariate = "hf")
```

#Stan N-mixture using ubms
```{r}
coyote_nmix_stan <- stan_pcount(formula =  ~ 1 ~ 
                       PC1 * hf + PC2 * hf,
                     data = umf_coyote,
                     chains = 3,
                     iter = 500)

coyote_nmix_stan
plot_effects(coyote_nmix_stan, submodel = "state")
```